# Session 28: First Hardware RL Deployment

**Date**: 2025-12-29
**Platform**: Raspberry Pi 5 (onboard Harold robot)
**Focus**: Deploy RL policy to physical robot

## Summary

Successfully deployed CPG-only walking gait to Harold robot. Policy integration has issues that need further investigation.

## Key Accomplishments

### 1. Hardware Verification
- ESP32 connected via USB (`/dev/ttyUSB0`) ✓
- IMU (MPU6050) connected via I2C (0x68) ✓
- All Python dependencies installed ✓

### 2. Firmware Flash
- Flashed `HaroldStreamingControl.ino` to ESP32 using `arduino-cli`
- Firmware implements:
  - Handshake protocol (`READY?#` → `ARDUINO_READY`)
  - Streaming commands (`START#`, `STOP#`)
  - 12-joint target commands with 250ms watchdog
  - Telemetry at 20 Hz

### 3. ESP32 Driver Fixes
The deployment driver (`esp32_serial.py`) had issues with the handshake failing due to telemetry flooding the response. Fixed by:
- Using direct `readline()` instead of buffered `_read_line()` for handshake
- Reading multiple lines (up to 20) to find `ARDUINO_READY` among telemetry
- Increasing boot wait from 0.5s to 2.0s after serial connect
- Similar fixes for `start_streaming()` and `stop_streaming()`

### 4. Deployment Results

| Mode | Result |
|------|--------|
| CPG-only | ✅ **WORKS PERFECTLY** - Smooth diagonal trot |
| CPG + Policy | ❌ Odd behavior (oscillation/vibration) |

## CPG-Only Deployment (Working)

Created `deployment/run_cpg_only.py` for stable deployment:

```bash
cd /home/pi/Desktop/harold/deployment
python run_cpg_only.py --duration 60
```

Performance:
- 20 Hz control rate achieved
- Zero overruns
- Clean diagonal trot gait (0.5 Hz, 2-second cycle)
- Robot on test stand showed proper leg coordination

## Policy Integration Issue

When policy inference is added to CPG, the robot exhibits odd behavior:
- Legs extend unexpectedly
- Vibration/oscillation during walking
- Occurs partway through runs, not just at startup

### Root Cause Investigation

The policy outputs are extremely large (raw values ~3500) before clipping. While the ActionConverter clips to [-1, 1] and applies proper scaling (residual_scale=0.05), something in the observation-to-action pipeline is causing issues.

Suspected causes:
1. **Observation mismatch**: Deployed observations may not match training distribution
2. **Normalization discrepancy**: Running mean/variance from training may not apply correctly
3. **Missing preprocessing**: Training may have additional clipping or scaling not replicated

### Next Steps for Policy Debugging
1. Log actual observations during deployment and compare to training expectations
2. Verify observation normalization is identical to training
3. Check if skrl's RunningStandardScaler applies any clipping
4. Consider training with observation clipping explicitly enabled

## Files Modified

| File | Changes |
|------|---------|
| `deployment/drivers/esp32_serial.py` | Fixed handshake/start/stop to handle telemetry flooding |
| `deployment/run_cpg_only.py` | **NEW** - CPG-only deployment script |

## Observations

1. **ESP32 DTR Reset**: Opening serial port resets ESP32 via DTR line. This is expected behavior for ESP32 DevKit boards.

2. **Telemetry Flooding**: ESP32 sends telemetry every 50ms. Response messages like `ARDUINO_READY` get interleaved and can be missed with simple single-line reads.

3. **CPG Reliability**: The CPG generator produces stable, repeatable trajectories that work well on hardware without policy corrections.

## Git Status
Changes to `esp32_serial.py` need to be reviewed before committing - they fix the deployment but may need cleanup.

---

# Session 29: Sim-to-Real Gap Investigation

**Date**: 2025-12-29 (evening)
**Platform**: Raspberry Pi 5 (onboard Harold robot)
**Focus**: Deep investigation into why policy outputs extreme values

## Summary

Conducted comprehensive investigation into sim-to-real gap. Identified root causes and created implementation plan for desktop agent.

## Key Findings

### 1. IMU Units Analysis
| Observation | Hardware | Isaac Lab | Status |
|-------------|----------|-----------|--------|
| Linear velocity | m/s (integrated accel, 0.95 decay) | m/s (physics engine) | Different source |
| Angular velocity | rad/s | rad/s | ✓ Match |
| Projected gravity | Z-up (+1 level) | Z-down (-1 level) | ✓ Fixed |

**Critical**: Hardware lin_vel uses accelerometer integration which drifts. Simulation provides perfect physics velocity.

### 2. Clipping/Preprocessing Analysis
| Component | Training | Deployment | Status |
|-----------|----------|------------|--------|
| Observation clipping | **None** | ±5.0 | Mismatch |
| Action clipping | None before scale | None before scale | ✓ Match |
| Joint limits | ±30°/±90° symmetric | Asymmetric | Mismatch |

### 3. Joint Limit Mismatch (Critical!)
| Joint | Training | Hardware |
|-------|----------|----------|
| Shoulder | ±30° | ±25° |
| Thigh | ±90° | -55° to +5° |
| Calf | ±90° | -5° to +80° |

**Impact**: Policy can command thigh angles up to +90° but hardware only allows +5°!

## User Decisions
- ✅ Add observation clipping to simulation (match deployment ±5.0)
- ✅ Add noise to simulation linear velocity (match noisy IMU)

## Deployment Code Fixes Applied

| File | Change |
|------|--------|
| `observation_builder.py` | Gravity sign flip, obs clipping ±5.0, default cmd 0.3 |
| `action_converter.py` | Removed pre-scaling clip (matches training) |
| `harold_controller.py` | Added 3-cycle CPG warmup |

## Implementation Plan for Desktop

1. Add lin_vel noise to simulation (std=0.05 m/s, bias std=0.02)
2. Add observation clipping to simulation
3. Align joint limits to hardware (especially thighs!)
4. Retrain and export new ONNX

Full details in: `.claude/plans/unified-knitting-lagoon.md`

## Files Created/Modified

| File | Changes |
|------|---------|
| `deployment/debug_observations.py` | **NEW** - Observation debugging script |
| `deployment/test_policy_verbose.py` | **NEW** - Verbose policy test |
| `deployment/inference/observation_builder.py` | Gravity flip, clipping, default commands |
| `deployment/inference/action_converter.py` | Removed pre-scaling clip |
| `deployment/inference/harold_controller.py` | Added warmup period |
| `deployment/run_cpg_only.py` | Fixed frequency attribute |

## Next Steps
- Desktop agent implements simulation changes
- Retrain policy with sim-to-real aligned config
- Export new ONNX and test on hardware
