# Session 22: Sim-to-Real Alignment

**Date**: 2025-12-26
**Duration**: ~2 hours
**Outcome**: ✅ SUCCESS - Real robot walking forward

## Objectives

1. Align simulation and hardware scripted gait parameters
2. Validate that real robot matches simulation behavior
3. Prepare for RL training with aligned parameters

## Key Achievements

### 1. Real Robot Walking Forward ✅

The real Harold robot now walks forward with the scripted diagonal trot gait. Motion is stable and controlled, though feet drag slightly.

### 2. Simulation Parameters Aligned ✅

Reduced simulation stiffness to match real servo "softness":
- stiffness: 1200 → 400
- damping: 50 → 40
- frequency: 1.0 → 0.5 Hz

### 3. Walking Direction Fixed ✅

Both sim and hardware were walking backward. Fixed by changing thigh trajectory from `+sin` to `-sin`.

## Technical Details

### Problem: Simulation Too Stiff

Real robot had more "give" than simulation. Sim looked "rigid and responsive" while real robot felt "flimsy".

**Root Cause**: Isaac Lab implicit actuator with stiffness=1200 was much stiffer than real FeeTech STS3215 servos.

**Solution**: Reduced stiffness to 400, proportionally reduced damping to 40.

### Problem: Robot Walking Backward

Both simulation and hardware walked backward with same gait pattern.

**Root Cause**: Thigh motion was 90° out of phase with foot contact. When foot was on ground, thigh was moving forward, pushing robot backward.

**Solution**: Changed hardware thigh trajectory from `+sin` to `-sin`:
```cpp
// Forward walking
*thigh = thigh_mid - thigh_amp * sin_phase;
```

### Problem: Sim/Hardware Parameter Mismatch

Initial hardware script had different values than simulation.

**Solution**: Computed exact conversions using `hardware_deg = -sim_rad × (180/π)`:

| Parameter | Simulation | Hardware |
|-----------|------------|----------|
| stance_thigh | +0.90 rad | -51.6° |
| swing_thigh | +0.40 rad | -22.9° |
| stance_calf | -0.90 rad | +51.6° |
| swing_calf | -1.40 rad | +80.0° |
| frequency | 0.5 Hz | 0.5 Hz |

## Observations

### Floor Surface Variation

Significant differences in gait behavior across:
- Hardwood floors (low friction)
- Short carpet (medium friction)
- Long carpet (high friction, more dragging)

**Implication**: Need friction domain randomization in RL training.

### Feet Dragging

Real robot drags feet during walking. Expected for early gait; can be improved by:
1. Increasing swing_calf bend
2. Adjusting calf trajectory timing
3. Adding foot clearance reward in RL

## Files Modified

1. **`harold.py`**
   - stiffness: 1200 → 400
   - damping: 50 → 40

2. **`harold_isaac_lab_env_cfg.py`**
   - frequency: 1.0 → 0.5 Hz
   - swing_calf: -1.55 → -1.40 rad (matched to HW 80° limit)

3. **`scripted_gait_test_1.ino`**
   - All parameters aligned with simulation
   - Thigh trajectory: `+sin` → `-sin`
   - Auto-start (removed Enter key requirement)
   - Slow transitions (THIGH_SPEED=400, CALF_SPEED=800)

## Simulation Results

With aligned soft parameters (stiffness=400):
- vx = +0.04 m/s forward
- height = 0.163 m
- upright = 1.0

## Next Steps

1. **PRIORITY 1**: Train RL with stiffness=400 (sim-to-real aligned)
2. **PRIORITY 2**: Add friction domain randomization
3. **PRIORITY 3**: Improve foot clearance during swing phase

## Session End State

- Simulation: Running with aligned parameters (stiffness=400, freq=0.5Hz)
- Hardware: Script ready, walks forward
- Memory files: Updated
- Ready for: RL training experiments
