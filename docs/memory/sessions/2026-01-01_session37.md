# Session 37: Explicit Backlash Hysteresis Modeling

**Date**: 2026-01-01
**Goal**: Implement explicit backlash hysteresis model to replace Gaussian noise approximation

## Summary

Implemented a proper hysteresis model for servo backlash (30° dead zone) to improve sim-to-real transfer. Previous approach of adding Gaussian noise (std=1°) was physically incorrect - backlash is hysteresis, not noise.

**Key Finding**: Explicit hysteresis model makes training HARDER, not easier. Policy can't learn to compensate for dead zone from scratch.

## Implementation

### Hysteresis Model (BacklashCfg)

Added to `harold_isaac_lab_env_cfg.py`:
```python
@configclass
class BacklashCfg:
    enable_backlash: bool = True/False
    backlash_rad: float = 0.52  # 30 degrees
```

Logic in `harold_isaac_lab_env.py`:
```python
def _apply_backlash_hysteresis(self, target):
    """
    gap = command - engaged_position
    if |gap| > half_backlash:
        engaged_position = command - sign(gap) * half_backlash
    # else: output stays where it is (dead zone)
    """
```

This models:
- Dead zone where motor can rotate without moving output
- Output lags by half_backlash when engaged
- Direction reversals must cross full backlash

### Observation Space Fix

Added gait phase (2D sin/cos) to observation for CPG mode:
- Pure RL: 48D (no gait phase)
- CPG mode: 50D (adds gait phase for timing)

## Experiment Results

| Exp | Configuration | vx (m/s) | Notes |
|-----|---------------|----------|-------|
| EXP-199 | Pure RL + 30° backlash | -0.016 | Moving BACKWARD |
| EXP-200 | Pure RL + 15° backlash | -0.005 | Oscillating around 0 |
| EXP-202 | CPG + 15° backlash | +0.002 | Slightly positive |
| EXP-203 | CPG baseline (no backlash, no noise) | +0.006 | Below 0.01 target |
| EXP-204 | CPG + joint noise (1°) | +0.005 | Similar to baseline |

**Comparison**: All Session 37 experiments with 50D observation (gait phase) underperformed compared to Session 35 (vx=0.036). This suggests the observation space change or other factors are affecting training.

## Key Findings

### 1. Explicit Hysteresis Makes Training Harder

The policy cannot learn to compensate for 30° dead zone from scratch. Even with 15° dead zone, training struggles. The hysteresis creates a nonlinear, discontinuous control problem that's hard for RL.

### 2. Gaussian Noise Acts as Regularization

Session 28 found 1° joint noise OPTIMAL (+35% vx improvement). This isn't because it simulates backlash physics - it's because it prevents overfitting and improves generalization.

### 3. Curriculum May Be Required

To train with backlash:
1. First train without backlash (get walking)
2. Fine-tune with increasing backlash

### 4. CPG Mode Helps But Not Enough

CPG provides base trajectory, but even with CPG, the backlash makes learning hard.

## Configuration Changes

**BacklashCfg** (NEW):
```python
enable_backlash: bool = False  # Disabled after experiments
backlash_rad: float = 0.26     # Reduced to 15°
```

**DomainRandomizationCfg**:
```python
add_joint_noise: bool = True   # Re-enabled (Session 28 optimal)
joint_position_noise.std = 0.0175  # 1° noise
```

**HaroldIsaacLabEnvCfg**:
```python
observation_space = 50  # For CPG mode (48 + 2 gait phase)
```

## Files Modified

- `harold_isaac_lab_env_cfg.py`: Added BacklashCfg, modified observation_space
- `harold_isaac_lab_env.py`: Added _apply_backlash_hysteresis(), modified _get_observations() for gait phase

## Next Steps

1. **Keep Gaussian noise approach** - Works better than explicit hysteresis
2. **Try curriculum with backlash** - Train baseline, then fine-tune with hysteresis
3. **Consider increasing CPG amplitudes** - Already done in Session 34 (50° calf swing)
4. **Hardware test with current policy** - Validate sim-to-real transfer

## Lessons Learned

1. Physical accuracy != training efficiency
2. Noise as regularization can be more effective than explicit physics
3. Discontinuous control problems need curriculum learning
